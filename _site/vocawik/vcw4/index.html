<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="ko" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[vocawik] 04/21 진행 내용 - pocj8ur4in’s blog</title>
<meta name="description" content="#10. init: github action 설정">


  <meta name="author" content="pocj8ur4in">
  
  <meta property="article:author" content="pocj8ur4in">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="ko_KR">
<meta property="og:site_name" content="pocj8ur4in's blog">
<meta property="og:title" content="[vocawik] 04/21 진행 내용">
<meta property="og:url" content="http://localhost:4000/vocawik/vcw4/">


  <meta property="og:description" content="#10. init: github action 설정">







  <meta property="article:published_time" content="2023-04-21T00:00:00+09:00">



  <meta property="article:modified_time" content="2023-04-21T00:00:00+09:00">



  

  


<link rel="canonical" href="http://localhost:4000/vocawik/vcw4/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "pocj8ur4in",
      "url": "http://localhost:4000/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="pocj8ur4in's blog Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon.ico">

<!-- end custom head snippets -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5003376222895357"
     crossorigin="anonymous"></script>
  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          pocj8ur4in
          <span class="site-subtitle">since 2022.09.01.</span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/categories/">카테고리</a>
            </li><li class="masthead__menu-item">
              <a href="/tags/">태그</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">토글 메뉴</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      




  
    



<nav class="breadcrumbs">
  <ol itemscope itemtype="https://schema.org/BreadcrumbList">
    
    
    
      
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/" itemprop="item"><span itemprop="name">Home</span></a>

          <meta itemprop="position" content="1" />
        </li>
        <span class="sep">/</span>
      
      
        
        <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
          <a href="/categories/#vocawik" itemprop="item"><span itemprop="name">Vocawik</span></a>
          <meta itemprop="position" content="2" />
        </li>
        <span class="sep">/</span>
      
    
      
      
        <li class="current">[vocawik] 04/21 진행 내용</li>
      
    
  </ol>
</nav>

  


<div id="main" role="main">
  


  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[vocawik] 04/21 진행 내용">
    <meta itemprop="description" content="#10. init: github action 설정">
    <meta itemprop="datePublished" content="2023-04-21T00:00:00+09:00">
    <meta itemprop="dateModified" content="2023-04-21T00:00:00+09:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title p-name" itemprop="headline">
            <a href="http://localhost:4000/vocawik/vcw4/" class="u-url" itemprop="url">[vocawik] 04/21 진행 내용
</a>
          </h1>
          

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          9 분 소요
        
      </span>
    
  </p>


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu"><li><a href="#10-init-github-action-설정">#10. init: github action 설정</a></li><li><a href="#7-fixgithub-workflows-수정">#7. fix:github workflows 수정</a></li><li><a href="#9-chorecicd-파이프라인-설정">#9. chore:CI/CD 파이프라인 설정</a></li><li><a href="#10-fixbootjar-task-수정">#10. fix:bootJar task 수정</a></li><li><a href="#13-docsexample-도메인-작성">#13. docs:Example 도메인 작성</a></li><li><a href="#14-featdomainbasetimeentity-추가">#14. feat/domain:BaseTimeEntity 추가</a></li><li><a href="#16-17-18-aws-ec2-인스턴스-설정">#16, #17, #18. AWS EC2 인스턴스 설정</a></li></ul>

            </nav>
          </aside>
        
        <h2 id="10-init-github-action-설정"><a href="https://github.com/pocj8ur4in/vw-backend/commit/43382309f6d0b6506372670d090c02f4d1d28a26">#10</a>. init: github action 설정</h2>

<ul>
  <li>Github에서 제공하는 workflow 자동화 도구인 Github Actions을 사용해 Github flow을 관리하게 한다.
    <ul>
      <li>또다른 CI/CD 도구인 Jenkins와 비교한 <a href="https://choseongho93.tistory.com/295">이 게시글</a>을 참고했을 때, 비교적 소규모 프로젝트인 우리의 경우에는 Github Action를 사용하는 게 좋을 것 같았다.</li>
      <li>Github Action과 관련해서 <a href="https://zzsza.github.io/development/2020/06/06/github-action/">해당 게시글</a>과 <a href="https://gmlwjd9405.github.io/2018/05/12/how-to-collaborate-on-GitHub-3.html">해당 게시글</a>을 참고하였다.</li>
      <li>도커 이미지를 생성하는 것은 <a href="https://docs.github.com/en/actions/publishing-packages/publishing-docker-images&gt;">이 문서</a> 내용이 좋은 것 같다.
<br /><br /></li>
    </ul>
  </li>
  <li>Github flow는 <a href="https://velog.io/@pond1029/Git-Workflow">해당 게시글</a>을 참고해 아래와 같이 간단히 작성해보았다.
    <ol>
      <li>개인 작업은 <code class="language-plaintext highlighter-rouge">dev</code> 브랜치에서 분리된 <code class="language-plaintext highlighter-rouge">feature</code>브랜치에서 작업하고, 작업이 끝나면 dev 브랜치에 대한 <code class="language-plaintext highlighter-rouge">pull request</code>를 생성한다.</li>
      <li><code class="language-plaintext highlighter-rouge">pull request</code>에서 코드를 리뷰하고, 여기서 문제가 없으면 <code class="language-plaintext highlighter-rouge">dev</code> 브랜치로 병합한다.</li>
      <li><code class="language-plaintext highlighter-rouge">dev</code>에서 <code class="language-plaintext highlighter-rouge">main</code> 브랜치에 병할할 때 배포 작업을 수행한다.
<br /><br /></li>
    </ol>
  </li>
  <li>이를 위해 브랜치 구성을 dev 브랜치와 main 브랜치 (default)로 변경하였다.
    <ul>
      <li>main 브랜치를 보호하기 위해 <a href="https://kotlinworld.com/292">해당 게시글</a>을 참고하여 Branch protection rules를 생성하였다.
<br /><br /></li>
    </ul>
  </li>
  <li>2번을 수행하기 위해, CI 자동화를 위한 yml 파일을 작성하였다. 이제 작업물을 <code class="language-plaintext highlighter-rouge">push</code>하거나 <code class="language-plaintext highlighter-rouge">pull request</code>를 보내면, 레포지토리에 merge되기 전에 빌드와 테스트가 자동화되어 실행된다.
    <ul>
      <li><a href="https://devjem.tistory.com/76">해당 게시글</a>을 참고하여 Github Actions에서 Gradle을 캐싱할 수 있도록 하였다.</li>
      <li><a href="https://velog.io/@bagt/Github-Actions를-통한-배포">해당 게시글</a>을 참고하여 AWS를 통한 배포 자동화 (CI)를 위해 빌드된 프로젝트를 미리 압축하도록 하였다.
<br /><br /></li>
    </ul>
  </li>
  <li>3번을 수행하려면, main 브랜치에 merge할 때, 즉 <code class="language-plaintext highlighter-rouge">pull request</code>가 종료하는 이벤트에 대한 트리거가 있어야 하는데… 기존에는 안되었던 거 같은데 (그리고 내 생각으로도 안되는 게 맞는 거 같은데), <a href="https://stackoverflow.com/questions/60710209/trigger-github-actions-only-when-pr-is-merged">이 포스트</a>에 따르면 되는 것 같아 일단 적용해보았다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>on:
  pull_request:
    types:
      - closed

jobs:
  if_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - run: |
        echo The PR was merged
</code></pre></div></div>

<ul>
  <li>또한 도커 허브에 저장소를 생성하고, 계정에 대한 토큰을 발급받아 GitHub 저장소에 secret key로 등록시켰다.</li>
</ul>

<h2 id="7-fixgithub-workflows-수정"><a href="https://github.com/Hongik-Challenge/hc-backend/commit/53500d50f4b8aafd11f7c1fd2034debfd97801b6">#7</a>. fix:github workflows 수정</h2>
<p><img src="https://user-images.githubusercontent.com/105341168/230152494-732dd033-54cf-4954-8016-eaf57b00c42c.png" alt="CleanShot 2023-04-06 at 02 03 08@2x" /></p>
<ul>
  <li>다소 난감한 상황이다. dev 브랜치는 이미 위의 <code class="language-plaintext highlighter-rouge">commit</code>을 반영된 상태인데 main 브랜치는 아직 반영되지 않은 상태이다. 그런데 main 브랜치에 <code class="language-plaintext highlighter-rouge">commit</code>을 적용해버린다면 dev 브랜치와는 영영 작별하는거고, dev 브랜치의 <code class="language-plaintext highlighter-rouge">commit</code>을 되돌리는 것은 이미 원격에 올라가서 불가능하다.
    <ul>
      <li>(아직 내가 혼자서 하는 부분이라 다행이지, 협엽에서 이러면 진짜진짜 혼난다…) 결국 main 브랜치를 삭제하고 dev 브랜치에서 다시 main 브랜치를 복제하는 식으로 해결했다. 즉, 이 <code class="language-plaintext highlighter-rouge">commit</code>은 아직 복제되기 전의 dev 브랜치에서 벌어지는 일이다.
<br /><br /></li>
    </ul>
  </li>
  <li>굉장히 긴 시행착오 끝에, 도커 허브에 파일 올라가는 거까지 확인하였다. 오류 수정이라 자세한 내용은 따로 다루지 않을 것이다. 여러 포스트들을 참고해 해결했는데, <a href="https://zzang9ha.tistory.com/404">이 포스트</a>가 제일 잘 정리된 거 같다. (AWS 배포까지 설명하시고 계시는데, 이 부분도 조만간 다룰 예정이다.)</li>
</ul>

<h2 id="9-chorecicd-파이프라인-설정"><a href="https://github.com/Hongik-Challenge/hc-backend/commit/851a75061eb7dc932f849fa688e96a79b10aeef0">#9</a>. chore:CI/CD 파이프라인 설정</h2>
<ul>
  <li>먼저 우리 프로젝트의 CI/CD 파이프라인은 아래 이미지와 유사하게 진행될 예정이다. 이전에 진행된 내용은 Github Action을 통해 도커 허브로 보내는 부분까지 진행되었다. 이번에는 <a href="https://goodgid.github.io/Github-Action-CI-CD-AWS-EC2/">해당 포스트</a>와 <a href="https://bcp0109.tistory.com/356">해당 포스트</a>를 참고하여, AWS EC2를 구축하고, 해당 EC2에 Elastic IP을 할당하였다.</li>
</ul>

<p><a href="https://velog.io/@apolontes/21.12.29-TIL45-무중단-배포-Github-Actions-Docker-AWS-EB"><img src="https://user-images.githubusercontent.com/105341168/230596272-8f5943f5-68cc-4e97-a931-7194e2acf266.png" /></a></p>

<ul>
  <li>도커 허브를 통해 EC2에 배포할 것이므로 사전에 도커 허브의 저장소를 만들어서 이전에 만든 Github workflow를 따라 빌드된 파일이 저장소에 업로드된 것을 확인하였다.
    <ul>
      <li><a href="https://medium.com/day34/container-repository-comparsion-dd4826f6a683">해당 포스트</a>에서는 도커 허브와 AWS ECR을 비교하고 있는데, 우리의 경우에는 조금 더 익숙한 도커 허브를 사용할 계획이다.</li>
    </ul>
  </li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230704906-10f6990d-2f72-4426-82ec-e4fb425efcee.png" alt="CleanShot 2023-04-08 at 14 24 44@2x" /></p>

<ul>
  <li>EC2의 인스턴스 유형은 프리티어인 t2.micro로, 운영 체제는 우분투로 설정하였다. (linux 기반 EC2는 자잘한 오류가 많다고 한다.)</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230702707-954aa971-fd6f-45c2-aa96-5c1fbbb7be9a.png" alt="CleanShot 2023-04-08 at 13 13 16@2x" /></p>

<ul>
  <li>아래 이미지와 같이 SSH로 접속해 EC2 내에 JDK와 CodeDeploy 플러그인을 설치하였다.</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230702762-5a56717a-322a-4de8-8e4a-54f71fc914dd.png" alt="CleanShot 2023-04-08 at 13 15 11@2x" /></p>

<ul>
  <li><a href="https://bcp0109.tistory.com/357">해당 포스트</a>를 참고하여, 아래 이미지와 같이 EC2에 연결할 데이터베이스를 위해 AWS RDS를 구축하였다.
    <ul>
      <li>해당 RDS의 RDBMS는 MysSQL로 설정하였다.</li>
    </ul>
  </li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230703114-8bd3cde8-8f10-40b6-9c32-fa7123e5c932.png" alt="CleanShot 2023-04-08 at 13 21 34@2x" /></p>

<ul>
  <li>해당 AWS RDS의 파라미터 그룹을 변경하여 저장하였다.</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230703499-8e8ceb25-d006-43e4-b73d-7007bbc68404.png" alt="CleanShot 2023-04-08 at 13 42 14@2x" /></p>

<ul>
  <li>아래 이미지와 같이 Intellij에서 RDS에 원격으로 접속되는 것까지 확인하였다.</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230703200-bc0ec63e-68c5-4ed8-8dfc-1caf6a607c6f.png" alt="CleanShot 2023-04-08 at 13 31 53@2x" /></p>

<ul>
  <li>EC2와 RDS의 연동을 위해 <a href="https://hiseon.me/linux/ubuntu/ubuntu-mysql-install/">해당 게시글</a>을 참고하여, EC2에 mysql-client를 설치하였다. 아래 이미지는 <code class="language-plaintext highlighter-rouge">sudo mysql_secure_installation</code>로 mysql를 초기화하였을 때 나오는 초기 설정으로, 래퍼런스가 정리되어 있지 않길래 나중에 필요할 때 확인할 수 있도록 첨부하였다.</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230704131-ee09fe07-d135-49fa-b2df-b24341ec6f5d.png" alt="CleanShot 2023-04-08 at 14 03 28@2x" /></p>

<ul>
  <li>mysql-client를 통해 EC2에서 RDS에 원격으로 접속되는 것까지 확인하였다.</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230704595-aa3b5417-85f2-4ba9-aa8a-20a83d9746e1.png" alt="CleanShot 2023-04-08 at 14 16 30@2x" /></p>

<ul>
  <li>추가로 GitHub Actions 또한 이를 반영해 동작하게 하기 위해, <a href="https://chb2005.tistory.com/191">해당 포스트</a>를 참고하여 yml 파일을 수정하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...

- name: Application Run
  uses: appleboy/ssh-action@v0.1.6
  with:
    host: $
    username: $
    key: $

    script: |
      sudo docker kill $
      sudo docker rm -f $
      sudo docker pull $/$:latest
            
      sudo docker run -p $:$ \
      --name $ \
      -e SPRING_DATASOURCE_URL=$ \
      -e SPRING_DATASOURCE_USERNAME=$ \
      -e SPRING_DATASOURCE_PASSWORD=$ \
      -d $/$
</code></pre></div></div>

<h2 id="10-fixbootjar-task-수정"><a href="https://github.com/Hongik-Challenge/hc-backend/commit/28e71ab5941b45feb6bfee14ad1914b73238cd58">#10</a>. fix:bootJar task 수정</h2>

<ul>
  <li>지난번에 도커 허브에 올라온 빌드 파일을 실행했을 때 기본 Manifest 속성이 없다는 오류가 나오면서 정상적으로 작동이 되지 않는 것을 확인하였다. 찾아보니 내가 이전에 참고했던 <a href="https://gist.github.com/ihoneymon/a2ed116069af470fec0d08110604c5db">해당 게시글</a>처럼 오류를 해결한 경우도 있지만, 이 둘을 반대로 진행한 <a href="https://earth-95.tistory.com/132">이 포스트</a>와 같은 경우도 있음을 확인하였다. 왜 그럴까?
    <ul>
      <li>BootJar task와 Jar task는 빌드를 통해 jar 파일을 만드는 작업이다. 그런데 이 둘이 동시에 존재하는 이유는 Jar은 의존성이 포함되지 않고 소스 코드의 클래스 파일과 리소스 파일만 포함한 Plain Jar을, BootJar은 의존성까지 포함해 어플리케이션 실행이 가능한 executable Jar을 만들기 때문이다.</li>
      <li>그러므로, 도커 이미지에 올라간 것은 Plain Jar라 실행이 되지 않는 것이라고 추측해볼 수 있다. 그래서 이를 고려해 build.gradle 파일을 수정하였다.</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bootJar.enabled = true
jar.enabled = false
</code></pre></div></div>

<ul>
  <li>그런데 이번엔 <code class="language-plaintext highlighter-rouge">Execution failed for task ':bootJar'.</code>이란 오류가 발생했다. 프로젝트의 build.gradle 파일을 보니 application이 없는 root 모듈에도 bootJar task를 실행시키는 것으로 되어 있어 수정하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bootJar.enabled = false
</code></pre></div></div>

<h2 id="13-docsexample-도메인-작성"><a href="https://github.com/Hongik-Challenge/hc-backend/commit/8d271922631c5b24bf620707daea803c4807c149">#13</a>. docs:Example 도메인 작성</h2>
<ul>
  <li>다른 팀원들이 도메인, API, 예외 처리에 대한 코드를 작성할 때 참고할 수 있도록 Example 코드를 작성하였다. 작성한 내용은 다음과 같다. (Example 코드인만큼 실제 코드가 어떤 역할을 하는지보다는, 해당 코드의 역할에 대한 개념을 설명하는 데에 초첨을 맞춰 서술한다.)
<br /></li>
  <li>Domain/ExampleEntity : 엔티티는 데이터베이스에 쓰일 필드와 여러 엔티티 간 연관관계를 정의한다. 아래의 2차원 테이블을 하나의 엔티티로 생각해보자. 우리는 이 테이블에 서비스에 필요한 정보를 활용할 수 있다. 이때 세로의 파란색 열 부분이 Column이 되고, 빨간색 부분과 같은 가로의 행 하나하나가 엔티티 객체라 볼 수 있다. 필드는 각각의 Column을 의미하는데, 엔티티 클래스에서 하나의 객체로 표현된다.</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/232203280-de59562c-8aca-403c-880a-bdbebbce2e98.png" alt="CleanShot 2023-04-15 at 18 11 03@2x" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@GeneratedValue(strategy = GenerationType.IDENTITY)
    @Id
    private Long example_id;

    private String example_content;
</code></pre></div></div>

<ul>
  <li>Domain/ExampleRepository : 엔티티는 위에서처럼 DB 구조를 표현한다면, 실제 DB의 값은 어떻게 접근할 수 있을까? 그리고 DB 값에 대한 CRUD는 어떻게 동작하는 것일까? 우리는 이를 위한 ExampleRepository를 인터페이스로 선언하고, JpaRepository를 상속하므로써 DB에 대한 접근 및 동작을 가능하게 해줄 예정이다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public interface ExampleRepository extends JpaRepository&lt;ExampleEntity, Long&gt; {}
</code></pre></div></div>

<ul>
  <li>Domain/ExampleDomainService : 이제 데이터베이스에서 값을 받아왔으니, 실제 도메인에서 이루어지는 서비스를 정의할 차례이다. 당연히 DB에 접근할 수 있어야 할 것이고, Repository의 메서드를 활용한 서비스를 정의해야 한다. 여기서는 Example이므로 Repository에서 값을 찾아올 수 없는 오류를 일으키고, 정의한 오류 내용이 제대로 출력되는지 확인해보았다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class ExampleDomainService {
    private final ExampleRepository exampleRepository;

    public void exampleException() {
      ...
    }

    public ExampleEntity exampleQuery(Long id) {
      return exampleRepository
                .findById(id)
                .orElseThrow(() -&gt; new ExampleCodeException(400, "샘플 오류!", "Example 도메인에서 발생한 샘플 오류입니다."));
    }

    public ExampleEntity exampleSave(String content) {
      ...
    }
}
</code></pre></div></div>

<ul>
  <li>Common/Exception/ExampleException : 위 내용을 실제로 출력될 수 있도록 오류에 대한 포맷을 만들어보았다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class ExampleCodeException extends RuntimeException {
    private int status;
    private String code;
    private String message;
}
</code></pre></div></div>

<ul>
  <li>Api/ExampleApiService : 위의 내용이 내부에서 동작하는 도메인 모듈에서 이루어지는 작업이었다면, 이제 외부로 출력할 수 있게끔 Api 모듈에서 작업할 차례이다. 그런데 왜 서비스가 나오는지 의아할 수 있는데, 이 서비스는 사실 DomainService와 MVC, DTO 사이에 존재하는 서비스로, DomainService를 재활용할 수 있도록 해당 Api 계층에 의존하는 내용을 분리시킨 것이다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class ExampleApiService {
    private final ExampleDomainService exampleDomainService;

    public ExampleResponse getExample() {
        ExampleEntity query = exampleDomainService.exampleQuery(1L);

        return ExampleResponse.from(query);
    }

    public ExampleResponse createExample(){
        ExampleEntity qwer = exampleDomainService.exampleSave("qwer");
        return ExampleResponse.from(qwer);
    }
}
</code></pre></div></div>

<ul>
  <li>Api/ExampleResponse : 요청 데이터 또는 응답 데이터를 하나의 객체로 주고받을 수 있는 DTO 클래스이다. 각 HandlerMethod에 대한 패러미터의 개수가 많아질 수 있고, 또 도메인 객체를 컨트롤러에서 분리하기 위해 사용하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class ExampleResponse {
    private final Long id;
    private final String content;

    public static ExampleResponse from(ExampleEntity exampleEntity) {
        return new ExampleResponse(
                exampleEntity.getExample_id(), exampleEntity.getExample_content());
    }
}
</code></pre></div></div>

<ul>
  <li>Api/ExampleController : 클라이언트의 요청을 직접 받을 엔드포인트 역할을 할 컨트롤러이다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class ExampleController {
    private final ExampleApiService exampleApiService;

    @GetMapping
    public ExampleResponse get(){
        return exampleApiService.getExample();
    }

    @PostMapping
    public ExampleResponse create(){
        return exampleApiService.createExample();
    }
}
</code></pre></div></div>

<h2 id="14-featdomainbasetimeentity-추가"><a href="https://github.com/Hongik-Challenge/hc-backend/commit/6209c2c954d5efd23d921c284ed13e1e37b764c3">#14</a>. feat/domain:BaseTimeEntity 추가</h2>
<ul>
  <li>생성 시간과 수정 시간을 자동으로 설정해주기 위해 JPA Auditing의 세부 기능 중 하나인 BaseTimeEntity를 추가하고, 이를 Example 도메인에 적용했다.
    <ul>
      <li>JPA Auditing은 데이터베이스에 데이터를 누가, 언제 데이터를 생성했는지, 수정했는지를 저장하는 업무를 담당한다. JPA Auditing을 이용하면 엔티티별로 동일한 필드명을 달고, 데이터를 넣어주는 코드를 중복적으로 짜지 않아도 된다.</li>
    </ul>
  </li>
</ul>

<blockquote>
  <p>이전에 생성한 AWS EC2의 용량을 너무 작게 설정해 (8GB), RDS는 그대로 두면서 EC2 인스턴스를 다시 생성하게 되었다. 그래서 커밋과 별개로 인스턴스에서 진행했던 작업들을 다시 진행하게 되었는데, 해당 내용은 커밋된 내용은 아니지만 시스템 구축에 관련된 작업이기에 따로 정리할 필요성을 느껴 이 부분을 다시 작성하게 되었다. (사실 이전에 생성하면서 작성된 내용과 중복되는 작업인데, 그때는 너무 러프하게 작성한 것 같아 좀 자잘하게 작성할 계획이다.)</p>
</blockquote>

<h2 id="16-17-18-aws-ec2-인스턴스-설정"><a href="https://github.com/Hongik-Challenge/hc-backend/commit/201893e469562860397b89c25e3d81db884848c7">#16</a>, <a href="https://github.com/Hongik-Challenge/hc-backend/commit/2a513dc6b7b1c755c4b32ff233cc399f16d8323d">#17</a>, <a href="https://github.com/Hongik-Challenge/hc-backend/commit/fe3812f93790745b6b80e146ae25afb25990667a">#18</a>. AWS EC2 인스턴스 설정</h2>

<ul>
  <li>EC2의 인스턴스 유형은 프리티어인 t2.micro로, 용량은 15GB로 운영 체제는 우분투로 설정하였다. (linux 기반 EC2는 자잘한 오류가 많다고 한다.)  다음은 EC2 인스턴스 생성과 관련하여 설정한 부분이다.
    <ul>
      <li>IntelliJ나 터미널 등의 SSH 클라이언트 접속을 위한 프라이빗 키 파일을 생성하였다.</li>
      <li>인스턴스에 대한 보안 그룹을 생성해, 인바운드 규칙과 아웃바운드 규칙을 지정하였다.</li>
      <li>탄력적 IP 주소를 할당받아, 이를 인스턴스에 연결하였다.</li>
      <li>IAM 역할을 변경하여 추후 연결할 데이터베이스 서버와 이미지 서버에 접근할 수 있게끔 하였다.</li>
    </ul>
  </li>
</ul>

<p><img src="https://user-images.githubusercontent.com/105341168/230702707-954aa971-fd6f-45c2-aa96-5c1fbbb7be9a.png" alt="CleanShot 2023-04-08 at 13 13 16@2x" /></p>

<ul>
  <li>SSH에 접속하는 과정에서 <code class="language-plaintext highlighter-rouge">WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!</code>라는 오류 메시지를 띄우면서, RSA 공유키 충돌 문제가 발생하였다. 그래서 <a href="https://kingsong.tistory.com/127">이 게시글</a>을 참고하여 known_hosts 파일을 지웠다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rm /root/.ssh/known_hosts 
</code></pre></div></div>

<ul>
  <li><a href="https://www.leafcats.com/168">SSH 클라이언트에 접속하여 사용자가 root 권한을 빌린다.</a></li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo su
</code></pre></div></div>

<ul>
  <li><a href="https://someone-life.tistory.com/17">패키지를 최신으로 업데이트하기 위해 이에 대한 확인 및 실행을 주기적으로 한다.</a>
    <ul>
      <li>패키지를 업데이트할 때나 패키지를 설치할 때마다 계속 핑크색 화면이랑 이런저런 log가 계속 나오는 게 신경쓰여 <a href="https://chhanz.github.io/linux/2022/08/01/ubuntu-22-04-needrestart/">해당 게시글</a>을 needrestart를 제거하고, Kernel Hint와 daemon 재시작 권고 설정 역시 비활성화하였다.</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt update &amp;&amp; sudo apt upgrade
</code></pre></div></div>

<ul>
  <li>그런데 일괄적으로 업데이트가 안되는 패키지가 있길래, 업그레이드 가능한 패키지를 확인하고 이를 개별로 설치하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt list --upgradable
apt install &lt;패키지명&gt;
</code></pre></div></div>

<ul>
  <li>(이전에 미처 체크하지 못한…) 디스크별 용량을 주기적으로 확인해두자.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>df -h
</code></pre></div></div>

<ul>
  <li>AWS 서비스를 관리할 수 있도록 AWS CLI를 설치하였다. 이전에 IAM 역할을 잘 변경했다면, s3나 rds 명령어도 잘 작동될 것이다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt install awscli
</code></pre></div></div>

<ul>
  <li>SpringBoot 프로젝트를 빌드할 수 있도록 JDK를 설치하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt install openjdk-17-jdk
java -version
javac -version
</code></pre></div></div>

<ul>
  <li>추가로 <code class="language-plaintext highlighter-rouge">vim ~/.bashrc</code>으로 JDK의 환경변수를 설정하고, <code class="language-plaintext highlighter-rouge">source ~/.bashrc</code>로 이를 적용하였다. (변경된 내용은 <code class="language-plaintext highlighter-rouge">echo $JAVA_HOME</code>로 확인해볼 수 있다.)</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
export PATH=$PATH:$JAVA_HOME/bin
</code></pre></div></div>

<ul>
  <li>아래의 명령어를 이용하여 도커를 설치하였는데, <code class="language-plaintext highlighter-rouge">Job for docker.service failed because the control process exited with error code</code>라는 오류가 발생하면서 도커가 실행되지 않아 <a href="https://dct-wonjung.tistory.com/entry/Docker-failed-control-process-exited-오류-해결">해당 게시글</a>을 통해 해결하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt install docker.io 
systemctl start docker
systemctl enable docker
</code></pre></div></div>

<ul>
  <li>이전에 프리티어가 메모리가 1기가밖에 안되어 소나큐브를 실행만 하면 계속 튕기는 일이 발생하였다. 사실 이런 일은 처음이라 감도 못 잡았다가 <a href="https://velog.io/@seungju0000/ec2-stop">이 게시글</a>로 어떤 일이 벌어지는지 대충이나마 이해하게 되었다. 그래서 이번에는 <a href="https://kth990303.tistory.com/361">해당 게시글</a>로 Swap File을 이용해 EC2 메모리 부족 현상을 해결해보고자 하였다.
    <ul>
      <li>스왑된 메모리는 <code class="language-plaintext highlighter-rouge">free</code> 명령어로 확인해볼 수 있다.</li>
      <li><code class="language-plaintext highlighter-rouge">top</code> 명령어로 메모리 할당량을 프로세스 별로 확인해볼 수 있다.</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dd if=/dev/zero of=/swapfile bs=128M count=16
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
</code></pre></div></div>

<ul>
  <li>스왑된 메모리가 자동으로 마운트가 가능할 수 있도록 <code class="language-plaintext highlighter-rouge">vi /etc/fstab</code>으로 <code class="language-plaintext highlighter-rouge">/etc/fstab</code> 파일의 맨 밑줄에 해당 명령어를 작성하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/swapfile swap swap defaults 0 0
</code></pre></div></div>

<ul>
  <li>그리고 톰캣을 설치하였는데, <a href="https://velog.io/@bonjaski0989/AWS-EC2-Linux-환경에서-톰캣-설치하기">이 게시글</a>에 잘 정리되어 있어 이를 그대로 작업하였다. (아, JAVA 환경변수는 이미 설정하였으므로 해당 부분만 제외하였다.)
    <ul>
      <li>톰캣을 매번 재시작할 수 있도록 <a href="https://velog.io/@bonjaski0989/EC2-Tomcat-서비스-등록">이 게시글</a>을 참고하였는데, 스크립트를 실행하는 과정에서 <code class="language-plaintext highlighter-rouge">files have no installation config</code>라는 오류가 발생하였다. 구글링해본 결과 Install 섹션을 활성화해야 한다고 하여 아래의 내용을 스크립트 파일에 추가하였다.</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<ul>
  <li>여러 개의 도커 컨테이너의 실행을 한 번에 관리할 수 있도록 도커 컴포즈를 설치하였다.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl -L "https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

docker-compose --version
</code></pre></div></div>

<ul>
  <li>도커로 SonarQube를 설치하였다. (사실 도커로 설치하지 않고 sonarqube를 설치한다면 아래의 작업들을 모두 진행해야 한다. 왜 아냐고? 다 했으니까… 근데 내가 설치한 자바 버전이랑 차이가 있어서 계속 오류가 났다.)
    <ul>
      <li>Java 설치, 환경설정</li>
      <li>DB 설치</li>
      <li>SonarQube에서 요구하는 DB table 생성</li>
      <li>DB 계정 생성 및 권한설정</li>
      <li>SonarQube 설치</li>
      <li>SonarQube에 DB 정보 설정</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run -d --name sonarqube -p 9000:9000 -p 9092:9092 sonarqube
</code></pre></div></div>

<ul>
  <li>그리고 이에 맞춰 Github workflow를 수정하였는데, <code class="language-plaintext highlighter-rouge">Permission denied(public key)</code>라는 문구를 띄우면서 Github Actions이 제대로 동작하지 않아 여러 커밋을 보냈다. 근데 원인은 Actions secrets and variables를 잘못 작성한 것이였다; 꼭, -BEGIN-와 -END- 부분도 지우지 말고 넣자.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        


  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> 카테고리: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#vocawik" class="page__taxonomy-item p-category" rel="tag">vocawik</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 업데이트:</strong> <time class="dt-published" datetime="2023-04-21">April 21, 2023</time></p>

      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">공유하기</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%5Bvocawik%5D+04%2F21+%EC%A7%84%ED%96%89+%EB%82%B4%EC%9A%A9%20http%3A%2F%2Flocalhost%3A4000%2Fvocawik%2Fvcw4%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fvocawik%2Fvcw4%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fvocawik%2Fvcw4%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="공유하기 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/vocawik/vcw3/" class="pagination--pager" title="[vocawik] 4/19 진행 내용
">이전</a>
    
    
      <a href="/vocawik/vcw5/" class="pagination--pager" title="[vocawik] 04/23 진행 내용
">다음</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h2 class="page__related-title">참고</h2>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/vocawik/vcw5/" rel="permalink">[vocawik] 04/23 진행 내용
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/vocawik/vcw3/" rel="permalink">[vocawik] 4/19 진행 내용
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          3 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">#3. init: 멀티모듈 세팅

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/vocawik/vcw2/" rel="permalink">[vocawik] 4/18 진행 내용
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">#1. init: git 저장소 생성

</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/vocawik/vcw1/" rel="permalink">[vocawik] 4/17 진행 내용
</a>
      
    </h2>
    

  <p class="page__meta">
    

    

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          최대 1 분 소요
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">
</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력하세요..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>팔로우:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/pocj8ur4in" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/pocj8ur4in" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 pocj8ur4in. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "http://localhost:4000/vocawik/vcw4/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/vocawik/vcw4"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://pocj8ur4in.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
