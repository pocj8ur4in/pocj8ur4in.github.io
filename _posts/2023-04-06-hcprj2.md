---
title: "[HongikChallenge] 04/06 진행 내용"

categories:
    - HongikChallenge

tag:

toc: true
toc_sticky: true

date: 2023-04-06
last_modified_at: 2023-04-06
---

> #5에 해당하는 ```commit```을 보면 이틀 전에 생성해 ```push```한 것인데, 저장소는 작성일을 오늘 날짜로 인식하고 있다. 그 부분은 사실 이전 내용에 오류가 있어 내가 ```Amend``` 명렁을 실행해버려서 그렇다... (원격 저장소의 ```commit```한 기록들이 다 달라져버리니, 협업할 때에는 절대 하면 안되는 짓이다. 다시는 그러지 말자.)

## #5. <a href="https://github.com/Hongik-Challenge/hc-backend/commit/739bbdeccc0205e552d17215c788898f489e1581">chore:github workflows 생성</a>
- Github에서 제공하는 workflow 자동화 도구인 Github Actions을 사용해 Github flow을 관리하게 한다.
  - Github Action과 관련해서 <a href="https://zzsza.github.io/development/2020/06/06/github-action/">해당 게시글</a>을 참고하였다.
  - 도커 이미지를 생성하는 것은 <a href="https://docs.github.com/en/actions/publishing-packages/publishing-docker-images>">이 문서</a> 내용이 좋은 것 같다.
<br><br>
- Github flow는 <a href="https://velog.io/@pond1029/Git-Workflow">해당 게시글</a>을 참고해 아래와 같이 간단히 작성해보았다.
  1. 개인 작업은 ```dev``` 브랜치에서 작업하고, 작업이 끝나면 ```pull request```를 생성한다.
  2. ```pull request```에서 코드를 리뷰하고, 여기서 문제가 없으면 ```main``` 브랜치로 병합한다.
  3. ```main``` 브랜치에 병할할 때 배포 작업을 바로 수행한다.
<br><br>
- 이를 위해 브랜치 구성을 dev 브랜치와 main 브랜치 (default)로 변경하였다.
  - main 브랜치를 보호하기 위해 <a href="https://kotlinworld.com/292">해당 게시글</a>을 참고하여 Branch protection rules를 생성하였다.
<br><br>

- 2번을 수행하기 위해, CI 자동화를 위한 yml 파일을 작성하였다. 이제 작업물을 ```push```하거나 ```pull request```를 보내면, 레포지토리에 merge되기 전에 빌드와 테스트가 자동화되어 실행된다.
  - <a href="https://devjem.tistory.com/76">해당 게시글</a>을 참고하여 Github Actions에서 Gradle을 캐싱할 수 있도록 하였다.
  - <a href="https://velog.io/@bagt/Github-Actions를-통한-배포">해당 게시글</a>을 참고하여 AWS를 통한 배포 자동화 (CI)를 위해 빌드된 프로젝트를 미리 압축하도록 하였다.
<br><br>
- 3번을 수행하려면, main 브랜치에 merge할 때, 즉 ```pull request```가 종료하는 이벤트에 대한 트리거가 있어야 하는데... 기존에는 안되었던 거 같은데 (그리고 내 생각으로도 안되는 게 맞는 거 같은데), <a href="https://stackoverflow.com/questions/60710209/trigger-github-actions-only-when-pr-is-merged">이 포스트</a>에 따르면 되는 것 같아 일단 적용해보았다.

```
on:
  pull_request:
    types:
      - closed

jobs:
  if_merged:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
    - run: |
        echo The PR was merged
```

- 또한 도커 허브에 저장소를 생성하고, 계정에 대한 토큰을 발급받아 GitHub 저장소에 secret key로 등록시켰다.

## #6. chore:Swagger3 설정
- <a href="https://velog.io/@dnwlsrla40/Swagger-Swagger3">해당 포스트</a>의 내용을 참고하여, REST 웹 서버로 요청되는 URL 리스트를 문서화 및 테스트 할 수 있는 Swagger3를 Api 모듈에 도입하였다. 
<br><br>
- Spring Boot 2.6 이상의 환경에서 Springfox3가 실행되지 않는 오류가 발생했다. 개발자 포럼에서도 자주 언급되는 유명한 이슈인데, 아직까지도 해결되지 않았다고 한다. Spring Boot 버전을 2.6 이하로 낮추는 것이 제일 안전한 방법이겠지만, 다른 해결책이 없나 구글링해보았더니 <a href="https://shanepark.tistory.com/366">이 포스트</a>에서 @EnableSwagger2 어노테이션 대신 @EnableWebMvc 어노테이션을 이용해 문제를 해결하길래 나도 적용해서 해결했다.
<br><br>
- 그런데 @EnableWebMvc 어노테이션을 추가하는 건 어떤 의미를 가질까? 라는 질문에 <a href="https://goodgid.github.io/Spring-Enable-MVC-Annotation/">해당 포스트</a>의 내용을 참고해 답변해본다면, @EnableWebMvc는 Spring 프레임워크에서 여러 Config 값을 알아서 설정해주는데 아래의 오류를 일으키는 ```this.condition``` 부분도 알아서 설정해주는 것 같다.

```
Caused by: java.lang.NullPointerException:
Cannot invoke "org.springframework.web.servlet.mvc.
condition.PatternsRequestCondition.getPatterns()"
because "this.condition" is null
```

- 그런데 Springfox3 오류를 해결하는 글들에서 여러 답변들을 내놓는 것을 보아, 위의 해결 방법이 적합하지 않은 것일 수 있다. (알아서 설정한다는 부분이, 좀 걸린다.) 일단은 Swagger3를 도입하는 데에는 문제가 없으니 지금은 넘어가지만, 혹시 모를 문제가 생기는지 계속 확인해보자. 사실 SwaggerConfig 클래스도 그냥 기본적인 내용만 적은 거라 설정을 다시 한 번 수정해야 한다.
<br><br>
- <a href="http://localhost:8080/swagger-ui/index.html">http://localhost:8080/swagger-ui/index.html</a>로 접속해보면 Swagger 페이지가 정상적으로 출력된다.
<br><br>
- 그리고 이번 ```commit```에서 GitHub workflow의 내용이 잘 적용되는지 확인하기 위해 ```pull request```을 만들었다. 그런데 docker-compose하는 분을 잘못 입력해서 ```pull request```가 실패하였다.

## #7. fix:github workflows 수정
![CleanShot 2023-04-06 at 02 03 08@2x](https://user-images.githubusercontent.com/105341168/230152494-732dd033-54cf-4954-8016-eaf57b00c42c.png)
- 다소 난감한 상황이다. dev 브랜치는 이미 위의 ```commit```을 반영된 상태인데 main 브랜치는 아직 반영되지 않은 상태이다. 그런데 main 브랜치에 ```commit```을 적용해버린다면 dev 브랜치와는 영영 작별하는거고, dev 브랜치의 ```commit```을 되돌리는 것은 이미 원격에 올라가서 불가능하다.
  - (아직 내가 혼자서 하는 부분이라 다행이지, 협엽에서 이러면 진짜진짜 혼난다...) 결국 main 브랜치를 삭제하고 dev 브랜치에서 다시 main 브랜치를 복제하는 식으로 해결했다. 즉, 이 ```commit```은 아직 복제되기 전의 dev 브랜치에서 벌어지는 일이다.
<br><br>
- 굉장히 긴 시행착오 끝에, 도커 허브에 파일 올라가는 거까지 확인하였다. 오류 수정이라 자세한 내용은 따로 다루지 않을 것이다. 여러 포스트들을 참고해 해결했는데, <a href="https://zzang9ha.tistory.com/404">이 포스트</a>가 제일 잘 정리된 거 같다. (AWS 배포까지 설명하시고 계시는데, 이 부분도 조만간 다룰 예정이다.)

## #8. chore:Jacoco 설정
- sub 모듈에 코드 커버리지 도구인 Jacoco를 도입하기 위해, <a href="https://seller-lee.github.io/java-code-coverage-tool-part2">이 게시글</a>을 참고하였다.
  - 코드 커버리지와 관련해, <a href="https://seller-lee.github.io/java-code-coverage-tool-part1">이 게시글</a>을 참고하였다.

```
apply plugin: 'jacoco'

jacoco {
    toolVersion = '0.8.9'
}
```

- 추후 SonarQube의 연동을 위해 jacocoTestReports task를 설정하였다. html, csv, xml 형태로 저장할 수 있게 해주고, xml 파일은 저장하는 경로를 다르게 설정하였다.

```
jacocoTestReport {
    dependsOn test
    reports {
        html.enabled true
        csv.enabled true
        xml.enabled true
        xml.destination file("${buildDir}/reports/jacoco.xml")
    }
}
```

- 원하는 코드 커버리지를 설정하고, 커버리지를 만족하는지 여부를 확인하는 데에 쓰이는 jacocoTestCoverageVerification task를 설정했는데... 이 정도는 되어야 통과된다, 라는 기준을 잘 모르겠어서 일단 이 내용은 코드에서 제외하였다.

```
jacocoTestCoverageVerification {
    violationRules {
        rule {
            limit {
                counter = 'BRANCH'
                value = 'COVEREDRATIO'
                minimum = 0.90
            }

            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.80
            }

            limit {
                counter = 'LINE'
                value = 'TOTALCOUNT'
                maximum = 200
            }
        }
    }
}
```

- 추가로 QueryDSL가 자동으로 생성하는 QDomain 클래스를 코드 커버리지에서 제외하였다.

```
jacocoTestCoverageVerification {
    def Qdomains = []

    for (qPattern in '*.QA'..'*.QZ') { // qPattern = '*.QA', '*.QB', ... '*.QZ'
        Qdomains.add(qPattern + '*')
    }
}
```

- 그런데 계속 ```./gradlew test --console verbose```를 하는데 계속 빌드가 안되더라...정말 미치는 줄 알았다. 이것저것 다 건들어도 안되서 구글링해보니 jacoco의 버전을 올려보라는 <a href="https://stackoverflow.com/questions/53911122/how-to-fix-error-while-creating-report-jacoco">답변</a>이 있길래, 설마? 하면서 했는데 성공했다. (이런 오류가 제일 싫더라)

```
jacoco {
    toolVersion = '0.8.7'
}
```

![CleanShot 2023-04-06 at 21 38 28@2x](https://user-images.githubusercontent.com/105341168/230381060-a2972bf0-8abb-4c92-b493-d19c3912106d.png)
