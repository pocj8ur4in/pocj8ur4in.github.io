---
title: "[HongikChallenge] 04/08 진행 내용"

categories:
    - HongikChallenge

tag:

toc: true
toc_sticky: true

date: 2023-04-08
last_modified_at: 2023-04-08
---

## <a href="https://github.com/Hongik-Challenge/hc-backend/commit/851a75061eb7dc932f849fa688e96a79b10aeef0">#9</a>. chore:CI/CD 파이프라인 설정
- 먼저 우리 프로젝트의 CI/CD 파이프라인은 아래 이미지와 유사하게 진행될 예정이다. 이전에 진행된 내용은 Github Action을 통해 도커 허브로 보내는 부분까지 진행되었다. 이번에는 <a href="https://goodgid.github.io/Github-Action-CI-CD-AWS-EC2/">해당 포스트</a>와 <a href="https://bcp0109.tistory.com/356">해당 포스트</a>를 참고하여, AWS EC2를 구축하고, 해당 EC2에 Elastic IP을 할당하였다.

<a href="https://velog.io/@apolontes/21.12.29-TIL45-무중단-배포-Github-Actions-Docker-AWS-EB"><img src="https://user-images.githubusercontent.com/105341168/230596272-8f5943f5-68cc-4e97-a931-7194e2acf266.png"></a>

- 도커 허브를 통해 EC2에 배포할 것이므로 사전에 도커 허브의 저장소를 만들어서 이전에 만든 Github workflow를 따라 빌드된 파일이 저장소에 업로드된 것을 확인하였다.
  - <a href="https://medium.com/day34/container-repository-comparsion-dd4826f6a683">해당 포스트</a>에서는 도커 허브와 AWS ECR을 비교하고 있는데, 우리의 경우에는 조금 더 익숙한 도커 허브를 사용할 계획이다.

![CleanShot 2023-04-08 at 14 24 44@2x](https://user-images.githubusercontent.com/105341168/230704906-10f6990d-2f72-4426-82ec-e4fb425efcee.png) 

- EC2의 인스턴스 유형은 프리티어인 t2.micro로, 운영 체제는 우분투로 설정하였다. (linux 기반 EC2는 자잘한 오류가 많다고 한다.)

![CleanShot 2023-04-08 at 13 13 16@2x](https://user-images.githubusercontent.com/105341168/230702707-954aa971-fd6f-45c2-aa96-5c1fbbb7be9a.png)

- 아래 이미지와 같이 SSH로 접속해 EC2 내에 JDK와 CodeDeploy 플러그인을 설치하였다.

![CleanShot 2023-04-08 at 13 15 11@2x](https://user-images.githubusercontent.com/105341168/230702762-5a56717a-322a-4de8-8e4a-54f71fc914dd.png)

- <a href="https://bcp0109.tistory.com/357">해당 포스트</a>를 참고하여, 아래 이미지와 같이 EC2에 연결할 데이터베이스를 위해 AWS RDS를 구축하였다.
  - 해당 RDS의 RDBMS는 MysSQL로 설정하였다. 

![CleanShot 2023-04-08 at 13 21 34@2x](https://user-images.githubusercontent.com/105341168/230703114-8bd3cde8-8f10-40b6-9c32-fa7123e5c932.png)

- 해당 AWS RDS의 파라미터 그룹을 변경하여 저장하였다.

![CleanShot 2023-04-08 at 13 42 14@2x](https://user-images.githubusercontent.com/105341168/230703499-8e8ceb25-d006-43e4-b73d-7007bbc68404.png)

- 아래 이미지와 같이 Intellij에서 RDS에 원격으로 접속되는 것까지 확인하였다.

![CleanShot 2023-04-08 at 13 31 53@2x](https://user-images.githubusercontent.com/105341168/230703200-bc0ec63e-68c5-4ed8-8dfc-1caf6a607c6f.png)

- EC2와 RDS의 연동을 위해 <a href="https://hiseon.me/linux/ubuntu/ubuntu-mysql-install/">해당 게시글</a>을 참고하여, EC2에 mysql-client를 설치하였다. 아래 이미지는 ```sudo mysql_secure_installation```로 mysql를 초기화하였을 때 나오는 초기 설정으로, 래퍼런스가 정리되어 있지 않길래 나중에 필요할 때 확인할 수 있도록 첨부하였다.

![CleanShot 2023-04-08 at 14 03 28@2x](https://user-images.githubusercontent.com/105341168/230704131-ee09fe07-d135-49fa-b2df-b24341ec6f5d.png)

- mysql-client를 통해 EC2에서 RDS에 원격으로 접속되는 것까지 확인하였다.

![CleanShot 2023-04-08 at 14 16 30@2x](https://user-images.githubusercontent.com/105341168/230704595-aa3b5417-85f2-4ba9-aa8a-20a83d9746e1.png)

- 추가로 GitHub Actions 또한 이를 반영해 동작하게 하기 위해, <a href="https://chb2005.tistory.com/191">해당 포스트</a>를 참고하여 yml 파일을 수정하였다.

```
...

- name: Application Run
  uses: appleboy/ssh-action@v0.1.6
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USERNAME }}
    key: ${{ secrets.EC2_KEY }}

    script: |
      sudo docker kill ${{ secrets.PROJECT_NAME }}
      sudo docker rm -f ${{ secrets.PROJECT_NAME }}
      sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.PROJECT_NAME }}:latest
            
      sudo docker run -p ${{ secrets.PORT }}:${{ secrets.PORT }} \
      --name ${{ secrets.PROJECT_NAME }} \
      -e SPRING_DATASOURCE_URL=${{ secrets.DB_URL }} \
      -e SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }} \
      -e SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }} \
      -d ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.PROJECT_NAME }}
```

## <a href="https://github.com/Hongik-Challenge/hc-backend/commit/28e71ab5941b45feb6bfee14ad1914b73238cd58">#10</a>. fix:bootJar task 수정

- 지난번에 도커 허브에 올라온 빌드 파일을 실행했을 때 기본 Manifest 속성이 없다는 오류가 나오면서 정상적으로 작동이 되지 않는 것을 확인하였다. 찾아보니 내가 이전에 참고했던 <a href="https://gist.github.com/ihoneymon/a2ed116069af470fec0d08110604c5db">해당 게시글</a>처럼 오류를 해결한 경우도 있지만, 이 둘을 반대로 진행한 <a href="https://earth-95.tistory.com/132">이 포스트</a>와 같은 경우도 있음을 확인하였다. 왜 그럴까?
  - BootJar task와 Jar task는 빌드를 통해 jar 파일을 만드는 작업이다. 그런데 이 둘이 동시에 존재하는 이유는 Jar은 의존성이 포함되지 않고 소스 코드의 클래스 파일과 리소스 파일만 포함한 Plain Jar을, BootJar은 의존성까지 포함해 어플리케이션 실행이 가능한 executable Jar을 만들기 때문이다.
  - 그러므로, 도커 이미지에 올라간 것은 Plain Jar라 실행이 되지 않는 것이라고 추측해볼 수 있다. 그래서 이를 고려해 build.gradle 파일을 수정하였다.

```
bootJar.enabled = true
jar.enabled = false
```

- 그런데 이번엔 ```Execution failed for task ':bootJar'.```이란 오류가 발생했다. 프로젝트의 build.gradle 파일을 보니 application이 없는 root 모듈에도 bootJar task를 실행시키는 것으로 되어 있어 수정하였다.

```
bootJar.enabled = false
```