---
title: "[HongikChallenge] 04/14 진행 내용"

categories:
    - HongikChallenge

tag:

toc: true
toc_sticky: true

date: 2023-04-14
last_modified_at: 2023-04-14
---

> 이전에 생성한 AWS EC2의 용량을 너무 작게 설정해 (8GB), RDS는 그대로 두면서 EC2 인스턴스를 다시 생성하게 되었다. 그래서 커밋과 별개로 인스턴스에서 진행했던 작업들을 다시 진행하게 되었는데, 해당 내용은 커밋된 내용은 아니지만 시스템 구축에 관련된 작업이기에 따로 정리할 필요성을 느껴 이 부분을 다시 작성하게 되었다. (사실 이전에 생성하면서 작성된 내용과 중복되는 작업인데, 그때는 너무 러프하게 작성한 것 같아 좀 자잘하게 작성할 계획이다.)

## <a href="https://github.com/Hongik-Challenge/hc-backend/commit/201893e469562860397b89c25e3d81db884848c7">#16</a>, <a href="https://github.com/Hongik-Challenge/hc-backend/commit/2a513dc6b7b1c755c4b32ff233cc399f16d8323d">#17</a>, <a href="https://github.com/Hongik-Challenge/hc-backend/commit/fe3812f93790745b6b80e146ae25afb25990667a">#18</a>. AWS EC2 인스턴스 설정

- EC2의 인스턴스 유형은 프리티어인 t2.micro로, 용량은 15GB로 운영 체제는 우분투로 설정하였다. (linux 기반 EC2는 자잘한 오류가 많다고 한다.)  다음은 EC2 인스턴스 생성과 관련하여 설정한 부분이다.
  - IntelliJ나 터미널 등의 SSH 클라이언트 접속을 위한 프라이빗 키 파일을 생성하였다.
  - 인스턴스에 대한 보안 그룹을 생성해, 인바운드 규칙과 아웃바운드 규칙을 지정하였다.
  - 탄력적 IP 주소를 할당받아, 이를 인스턴스에 연결하였다.
  - IAM 역할을 변경하여 추후 연결할 데이터베이스 서버와 이미지 서버에 접근할 수 있게끔 하였다.

![CleanShot 2023-04-08 at 13 13 16@2x](https://user-images.githubusercontent.com/105341168/230702707-954aa971-fd6f-45c2-aa96-5c1fbbb7be9a.png)

- SSH에 접속하는 과정에서 ```WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!```라는 오류 메시지를 띄우면서, RSA 공유키 충돌 문제가 발생하였다. 그래서 <a href="https://kingsong.tistory.com/127">이 게시글</a>을 참고하여 known_hosts 파일을 지웠다.

```
rm /root/.ssh/known_hosts 
```

- <a href="https://www.leafcats.com/168">SSH 클라이언트에 접속하여 사용자가 root 권한을 빌린다.</a>

```
sudo su
```

- <a href="https://someone-life.tistory.com/17">패키지를 최신으로 업데이트하기 위해 이에 대한 확인 및 실행을 주기적으로 한다.</a>
  - 패키지를 업데이트할 때나 패키지를 설치할 때마다 계속 핑크색 화면이랑 이런저런 log가 계속 나오는 게 신경쓰여 <a href="https://chhanz.github.io/linux/2022/08/01/ubuntu-22-04-needrestart/">해당 게시글</a>을 needrestart를 제거하고, Kernel Hint와 daemon 재시작 권고 설정 역시 비활성화하였다. 

```
apt update && sudo apt upgrade
```

- 그런데 일괄적으로 업데이트가 안되는 패키지가 있길래, 업그레이드 가능한 패키지를 확인하고 이를 개별로 설치하였다.

```
apt list --upgradable
apt install <패키지명>
```

- (이전에 미처 체크하지 못한...) 디스크별 용량을 주기적으로 확인해두자.

```
df -h
```

- AWS 서비스를 관리할 수 있도록 AWS CLI를 설치하였다. 이전에 IAM 역할을 잘 변경했다면, s3나 rds 명령어도 잘 작동될 것이다.

```
apt install awscli
```

- SpringBoot 프로젝트를 빌드할 수 있도록 JDK를 설치하였다.

```
apt install openjdk-17-jdk
java -version
javac -version
```

- 추가로 ```vim ~/.bashrc```으로 JDK의 환경변수를 설정하고, ```source ~/.bashrc```로 이를 적용하였다. (변경된 내용은 ```echo $JAVA_HOME```로 확인해볼 수 있다.)

```
export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which java))))
export PATH=$PATH:$JAVA_HOME/bin
```

- 아래의 명령어를 이용하여 도커를 설치하였는데, ```Job for docker.service failed because the control process exited with error code```라는 오류가 발생하면서 도커가 실행되지 않아 <a href="https://dct-wonjung.tistory.com/entry/Docker-failed-control-process-exited-오류-해결">해당 게시글</a>을 통해 해결하였다.

```
apt install docker.io 
systemctl start docker
systemctl enable docker
```

- 이전에 프리티어가 메모리가 1기가밖에 안되어 소나큐브를 실행만 하면 계속 튕기는 일이 발생하였다. 사실 이런 일은 처음이라 감도 못 잡았다가 <a href="https://velog.io/@seungju0000/ec2-stop">이 게시글</a>로 어떤 일이 벌어지는지 대충이나마 이해하게 되었다. 그래서 이번에는 <a href="https://kth990303.tistory.com/361">해당 게시글</a>로 Swap File을 이용해 EC2 메모리 부족 현상을 해결해보고자 하였다.
  - 스왑된 메모리는 ```free``` 명령어로 확인해볼 수 있다.
  - ```top``` 명령어로 메모리 할당량을 프로세스 별로 확인해볼 수 있다.

```
dd if=/dev/zero of=/swapfile bs=128M count=16
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile
```

- 스왑된 메모리가 자동으로 마운트가 가능할 수 있도록 ```vi /etc/fstab```으로 ```/etc/fstab``` 파일의 맨 밑줄에 해당 명령어를 작성하였다.

```
/swapfile swap swap defaults 0 0
```

- 그리고 톰캣을 설치하였는데, <a href="https://velog.io/@bonjaski0989/AWS-EC2-Linux-환경에서-톰캣-설치하기">이 게시글</a>에 잘 정리되어 있어 이를 그대로 작업하였다. (아, JAVA 환경변수는 이미 설정하였으므로 해당 부분만 제외하였다.)
  - 톰캣을 매번 재시작할 수 있도록 <a href="https://velog.io/@bonjaski0989/EC2-Tomcat-서비스-등록">이 게시글</a>을 참고하였는데, 스크립트를 실행하는 과정에서 ```files have no installation config```라는 오류가 발생하였다. 구글링해본 결과 Install 섹션을 활성화해야 한다고 하여 아래의 내용을 스크립트 파일에 추가하였다.

```
[Install]
WantedBy=multi-user.target
```

- 여러 개의 도커 컨테이너의 실행을 한 번에 관리할 수 있도록 도커 컴포즈를 설치하였다.

```
curl -L "https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

docker-compose --version
```

- 도커로 SonarQube를 설치하였다. (사실 도커로 설치하지 않고 sonarqube를 설치한다면 아래의 작업들을 모두 진행해야 한다. 왜 아냐고? 다 했으니까... 근데 내가 설치한 자바 버전이랑 차이가 있어서 계속 오류가 났다.)
  - Java 설치, 환경설정
  - DB 설치
  - SonarQube에서 요구하는 DB table 생성
  - DB 계정 생성 및 권한설정
  - SonarQube 설치
  - SonarQube에 DB 정보 설정

```
docker run -d --name sonarqube -p 9000:9000 -p 9092:9092 sonarqube
```

- 그리고 이에 맞춰 Github workflow를 수정하였는데, ```Permission denied(public key)```라는 문구를 띄우면서 Github Actions이 제대로 동작하지 않아 여러 커밋을 보냈다. 근데 원인은 Actions secrets and variables를 잘못 작성한 것이였다; 꼭, -BEGIN-와 -END- 부분도 지우지 말고 넣자.

```
-----BEGIN OPENSSH PRIVATE KEY-----
...
-----END OPENSSH PRIVATE KEY-----
```